---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import ListingCard from '../../components/ListingCard.astro';
import AdSlot from '../../components/AdSlot.astro';
import { toCanonical } from '../../config/site';

export async function getStaticPaths() {
  const listings = await getCollection('listings');
  return listings.map((listing) => ({ params: { slug: listing.slug }, props: { listing } }));
}

const { listing } = Astro.props;
const allListings = await getCollection('listings');
const related = allListings.filter(
  (candidate) =>
    candidate.slug !== listing.slug &&
    (candidate.data.category === listing.data.category || candidate.data.city === listing.data.city),
);

const { Content } = await render(listing);
const canonical = toCanonical(Astro.url.pathname);

function toPostalAddress(address?: string, city?: string) {
  if (!address) {
    return undefined;
  }

  const [streetAddress, ...rest] = address.split(',').map((part) => part.trim());
  const cityFromAddress = rest[0] || city;
  const stateZip = rest[1] || '';
  const match = stateZip.match(/^(?<state>[A-Z]{2})\s*(?<postalCode>\d{5}(?:-\d{4})?)?$/);

  return {
    '@type': 'PostalAddress',
    streetAddress,
    addressLocality: cityFromAddress,
    addressRegion: match?.groups?.state,
    postalCode: match?.groups?.postalCode,
    addressCountry: 'US',
  };
}

const listingSchema = {
  '@context': 'https://schema.org',
  '@type': listing.data.category.toLowerCase() === 'wineries' ? 'LocalBusiness' : 'Thing',
  name: listing.data.title,
  description: listing.data.description,
  url: canonical,
  sameAs: listing.data.website,
  mainEntityOfPage: canonical,
  telephone: listing.data.phone,
  address: toPostalAddress(listing.data.address, listing.data.city),
  areaServed: listing.data.city,
  priceRange: listing.data.priceRange,
  keywords: listing.data.bestFor.join(', '),
};
---

<BaseLayout title={listing.data.title} description={listing.data.description}>
  <article>
    <h1>{listing.data.title}</h1>
    <p>{listing.data.description}</p>
    <ul>
      <li><strong>Category:</strong> {listing.data.category}</li>
      <li><strong>City:</strong> {listing.data.city}</li>
      {listing.data.address && <li><strong>Address:</strong> {listing.data.address}</li>}
      {listing.data.phone && <li><strong>Phone:</strong> {listing.data.phone}</li>}
      {listing.data.hours && <li><strong>Hours:</strong> {listing.data.hours}</li>}
      {listing.data.rating !== undefined && <li><strong>Rating:</strong> {listing.data.rating}</li>}
      {listing.data.priceRange && <li><strong>Price range:</strong> {listing.data.priceRange}</li>}
      {listing.data.bestFor.length > 0 && <li><strong>Best for:</strong> {listing.data.bestFor.join(', ')}</li>}
      {listing.data.outsideFoodPolicy && (
        <li><strong>Outside food policy:</strong> {listing.data.outsideFoodPolicy}</li>
      )}
      {listing.data.outsideFoodCost && (
        <li><strong>Outside food cost:</strong> {listing.data.outsideFoodCost}</li>
      )}
      {listing.data.website && (
        <li>
          <strong>Website:</strong> <a href={listing.data.website}>{listing.data.website}</a>
        </li>
      )}
      {listing.data.maps && (
        <li>
          <strong>Map:</strong> <a href={listing.data.maps}>Open in Google Maps</a>
        </li>
      )}
    </ul>
    <Content />
  </article>

  <AdSlot slotName="listing-inline" position="inline" />

  <section>
    <h2>Related Listings</h2>
    {related.length === 0 ? <p>No related listings found.</p> : related.slice(0, 4).map((entry) => <ListingCard listing={entry} />)}
  </section>

  <script type="application/ld+json" set:html={JSON.stringify(listingSchema)}></script>
</BaseLayout>
